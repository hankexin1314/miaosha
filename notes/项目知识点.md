# 框架

## 项目的搭建

### 最初

- Druid连接池，Mybatis，MySQL数据库

- Redis配置在Mac上
- 前端Thymeleaf框架，使用Model对象传递参数，return到一个页面

#### 登录

- 前端传加密后的登录信息到后端
- 后端接收后加密密码，然后和数据库中的比对
- 比对成功后，写入Session和Cookie
- 跳转到商品列表页

#### 商品列表

- 从数据库中查商品列表，通过Model对象传递参数到前端，显示页面

#### 秒杀

- 检测是否登录
- 查询数据库判断库存
- 查询redis，判断是否已经秒杀过一次了
- 减库存（操作数据库）
- 插入订单（操作数据库）
- 插入秒杀订单（操作数据库）

## 一、Redis的使用

### 自定义Redis连接池

- 配置信息写在yml文件中，新建JedisPoolConfig配置类对象，然后创建一个JedisPool对象
- 设置允许最大空闲连接数，最大激活连接数，连接消耗完毕后，请求最长等待时间
- 设置端口，host，时延，密码
- 通过`jedisPool.getResource()`获取新的链接，然后用get，set访问缓存
- redis中存的是JSON字符串，还需要JSON工具类`JSON.toJavaObject()`和`JSON.toJSONString()`来实现JSON和对象之间的转化，封装一下

### 通用缓存Key

- Redis中需要存好多内容，避免key混淆，将set和get封装一下，可以自动增加前缀。
- get和set需要传入**key**，**封装的对象或者获取的对象的类型**，还有就是**前缀类**
- **前缀类**通过定义接口，抽象类和具体实现类实现，有两个成员变量，prefix和过期时间
- 通过定义静态方法来创建**前缀类**，真正的key为`前缀类.class + : prefix + 传入的key`
- 便于管理

### Redis实现分布式Session

## 三、通用结果集

- Result类，内置静态success和error方法，禁止使用new创建对象，只能使用success和error创建对象
- 成员变量包含**msg**，**错误代码**，和一个**泛型类**，
- msg和错误代码是为了提示信息，泛型类是为了向前端传递数据信息
- CodeMsg类，包含msg和错误代码，方便管理错误信息

# 功能的最初实现

## 一、登录功能

- 前端将收到的登录信息传到后端
- 后端查询数据库比对，比对成功
- 向响应中添加cookie，在服务器的redis中存session并返回成功信息

> Cookie格式 token：uuid
>
> Session格式 MiaoshaUserKey：tk + uuid user信息

- 跳转到商品列表